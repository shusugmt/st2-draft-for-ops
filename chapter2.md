## DMM.com ラボのインフラが目指す運用プラットフォーム
　本編前半で解説した StackStorm の特徴を踏まえ、DMM.com ラボのインフラの運用において StackStorm がどのようなケースで、どのような効果を発揮している（することを期待している）かをご紹介します。  

### 低コスト・低リスクのサービスインフラ運用の取り組み
　一般的に運用者がオペレーションを行う対象は、フルマネージドサービスでない場合、サービスを提供するシステムに加え、システムを支えるミドルウェア、アプライアンス、及びそれらを管理するシステムなど多数存在します。また、提供サービスの規模・機能が拡張することで、運用者がオペレーションを行う対象は更に、多種・多様化することが予想されます。  

　例えば計算機リソースを作成し、それをサービス環境に投入する場合を想像してみてください。  

![多種多用なシステムの運用](https://raw.githubusercontent.com/userlocalhost/st2-draft-for-ops/master/images/operation1.png)

　この場合、運用者はたくさんのオペレーション *（まずサーバ管理システムを操作して計算機リソースを確保。そしてストレージからボリュームを切り出し、確保した計算機に割り当てる。続いてネットワーク設定、DNS へのホスト登録などを行い、更にサービスコンテンツのデプロイを行った後、ロードバランサに登録し、構成管理システムへの登録など）* を行う必要があります。  

　このように運用者が様々な機器・システムに対して個別的なオペレーションを直接行う運用には、高いコストとリスクが伴います。  

　まず運用者は多種多様なシステムのオペレーションに精通しなければならず、これに対する学習（教育）のコストがかかります。また一人の運用者でカバーしきれないほどシステムが大規模・複雑化する場合には、それぞれのシステムに精通した運用者が組織的に対応しなければならず、これによって管理コストが大きくなります。  
　加えて、システムへのオペレーションを行う際、未熟な運用者によるオペレーションや、複雑なオペレーションを実施する場合、オペレーションミスによる障害リスクも高まります。  

　DMM.com ラボのインフラでは、運用コストを低減させるために StackStorm を利用し、オペレーション対象のシステムを抽象化する取り組みを行っています。  
　例えば、先ほどの計算機リソースの作成とサービス投入の作業を StackStorm がある環境で行った場合、次のようになります。  

![StackStorm によるシステムの抽象化](https://raw.githubusercontent.com/userlocalhost/st2-draft-for-ops/master/images/operation2.png)
 
　運用者の作業は欲しい結果（新たな計算機リソースがサービスに追加されている状態）を StackStorm に対して指定するだけで済み、個別の機器・システムに対するオペレーションは StackStorm が実施します。このようにすることで、運用者によるシステムの運用コストが低減するだけでなく、機器やシステムの存在を運用者に意識させないことで、個別の機器やシステムの入れ替えを従来と比べて容易できるようになる効果も期待しています。  
　また StackStorm では個別の機器・システムへのオペレーションや、イベントハンドリングを行うソフトウェアコンポーネントをモジュール化しており、運用者は [これまでにコミュニティによって開発されたモジュール](https://exchange.stackstorm.org/) を利用することができます。そして、それらの多くは機能的なテストを経て、多くのユーザによって利用されている実績を積んでいます。個別の機器・システムに対するオペレーションをこうしたソフトウェアで行うことでオペレーションミスを防止し、より安全な運用が行えるようになると見込んでいます。  
　更に StackStorm の IFTTT 機能を活用し、それぞれの機器・システムにおける様々なケースの障害に対して、統一的な方法で障害対応方法を定義することができます。今後は、こうした仕組みを利用した障害一次対応の自動化にも取り組んでいきたいと考えています。  

![障害一次対応の自動化](https://raw.githubusercontent.com/userlocalhost/st2-draft-for-ops/master/images/operation5.png)

### 事業部向き合いの業務負荷軽減の取り組み
　ここで述べる内容は、前半の DevOps で紹介した例と同じ背景ですが、サービス運用者の立場から見た課題と StackStorm で何を解決しようとしているかについて紹介します。  

　DMM.com ラボのインフラ担当部署（以下 "インフラ"）では、DMM.com がお客さまにご提供するサービスを運営する事業部やアプリケーション開発を行う部署に対して共通のインフラサービスを提供しています。  

![DMM.com ラボのインフラ運用の概要](https://raw.githubusercontent.com/userlocalhost/st2-draft-for-ops/master/images/operation3.png)

　インフラは対象システム、及びオペレーションの内容に応じたワークフロー（定型化された依頼を利用者がどのように申請し、申請された依頼に対してどのようにインフラの担当者がオペレーションを実施、報告するかを規定した一連の作業マニュアル）を定義します。インフラ利用者はこれに沿った形で依頼内容を所定のフォームに記載し、インフラに対して依頼を出します。依頼を受け取ったインフラは、出された依頼の内容に応じて担当者が必要なオペレーションを行います。  

　このように利用者が依頼内容を記述し、インフラの担当者がそれを読み下す運用は、非定型化された依頼 (`"xxx の設計をしてほしい"`, `"yyy の問題の調査をしてほしい"` など) を対応する場合には効果的である一方、機械的に処理可能な定型的な内容の依頼 (`"以下のサーバを xx 台構築 (設定変更・削除) してほしい"` など) を対応する場合には運用コストが高くつくと思われます。  

　DMM.com ラボのインフラでも利用者からの依頼に対応するためのワークフローを定義していますが、チャットなどの非定型的なコミュニケーションパスでインフラ運用者に対して直接、定型作業の依頼を受け、インフラの運用担当者が忙殺されている様子を時々目にします。  
　またオペレーションに人間が介在するため、事業が拡大（事業部のスケールアップ・スケールアウト）した場合、インフラの人員規模も拡大を余儀なくされます。これにより、インフラの管理・運用コストがさらに増大します。  

　こうした問題に対する一般的な解決方法として、インフラを利用するアプリケーション開発者がプログラマブルに操作可能なインフラサービスを利用して、開発者が直接インフラを運用するといった方法があります。  
　これに対してDMM.com ラボのインフラでもインフラのサービス化に加え、様々なシステムのイベントを監視し、定型化されたオペレーションをコード化することで、定型作業を自動化する取り組みを行っています。  

![理想的なシステムの運用](https://raw.githubusercontent.com/userlocalhost/st2-draft-for-ops/master/images/operation4.png)

　具体的には、構成管理システムやソースコード管理システムのリポジトリの更新などのイベントを検知し、コード化したオペレーションを実行することで、インフラ担当者の定型作業を自動化しようとしています。  

　これにより、インフラは個々のシステム自体の管理・運用に専念できるようになるため、より高機能なインフラサービスの提供が可能になると見込んでいます。  
　またカタログ化されたオペレーションを API として提供することで、全てのアプリケーション開発者がプログラマブルにシステムへのオペレーションが行えるようになります。これにより、要求を出してからオペレーションが完了するまでのリードタイムが短縮し、利用者がより効率的にインフラを利用できるようになると見込んでいます。  
　更に、オペレーションに人間が介在しないため、事業がスケールしても、オペレーションのための人員増加は必要なくなります。この場合、StackStorm 自体のスケーラビリティが要求されますが、StackStorm は [スケーラブルなアーキテクチャ](https://docs.stackstorm.com/reference/ha.html) となっており、こうした利用者の規模の増減に対しも柔軟に対応できると見込んでいます。  

### おわりに
　ここまで、DMM.com ラボのシステムの運用における課題の一部について、どのように解決しようとしているかをご紹介しました。  
　現在これらの課題解決に取り組んでいる最中のために、全てにおいて期待通りの結果が得られるかは本稿執筆時点ではわかりません。もし期待した結果が得られなかった場合には、その詳細 *（どのような要因が何に対してどのように作用した為にどのようになったかについて）* をまたの機会でご紹介できたらと思います。  
